# PLC 모니터링 시스템 아키텍처 설계

이 문서는 Modbus TCP 데이터 수집, 웹 애플리케이션을 통한 설정 관리, 그리고 경량 모니터링 UI에 중점을 둔 실시간 PLC 모니터링 시스템의 아키텍처를 설명합니다.

## 1. 전체 아키텍처

시스템은 Docker 컨테이너를 사용하여 오케스트레이션되는 세 가지 주요 구성 요소로 이루어져 있습니다:

*   **특화된 웹 애플리케이션**: 설정 관리를 처리하고 모니터링 UI를 제공합니다.
*   **Node-RED**: Modbus TCP 데이터 수집 및 처리를 위한 핵심 역할을 합니다.
*   **공유 설정 파일**: `plc_address_map.json`은 Modbus 데이터 포인트 정의를 위한 중앙 정보원 역할을 합니다.

```
+---------------------+       +---------------------+       +-----------------+
|                     |       |                     |       |                 |
|  특화된 웹          |       |      Node-RED       |       |   MQTT Broker   |
|  애플리케이션       |       |  (Modbus 코어)      |       |                 |
|  (Svelte 프론트엔드)|       |                     |       |                 |
|  (Express 백엔드)   |       |                     |       |                 |
|                     |       |                     |       |                 |
+----------+----------+       +----------+----------+       +--------+--------+
           |                            |                            |
           | WebSocket (실시간 데이터)  |                            |
           |                            |                            |
           +----------------------------+                            |
           |                            |                            |
           | HTTP API (설정)            |                            |
           |                            |                            |
           +----------------------------+                            |
           |                            |                            |
           | 공유 Docker 볼륨           |                            |
           | (plc_address_map.json)     |                            |
           |                            |                            |
           +----------------------------+                            |
                                        |                            |
                                        +----------------------------+
                                             MQTT (내부 데이터 발행)
```

## 2. 구성 요소별 설명

### 2.1. 특화된 웹 애플리케이션

*   **기술 스택**:
    *   **프론트엔드**: Svelte
    *   **백엔드**: Node.js Express
*   **책임**:
    *   **설정 관리 UI**: 사용자가 `plc_address_map.json` 내용을 보고(그리고 잠재적으로 편집)할 수 있는 웹 인터페이스를 제공합니다. Express 백엔드는 이 파일을 Svelte 프론트엔드에 제공합니다.
    *   **실시간 모니터링 UI**: Node-RED로부터 수신된 실시간 PLC 데이터를 표시합니다.
*   **통신**:
    *   **프론트엔드에서 백엔드**: HTTP API 호출 (예: `plc_address_map.json` 가져오기).
    *   **프론트엔드에서 Node-RED**: 실시간 데이터를 수신하기 위한 WebSocket 연결.

### 2.2. Node-RED

*   **역할**: PLC 통신 및 데이터 처리를 위한 핵심 엔진.
*   **책임**:
    *   **설정 로딩**: 시작 시 또는 배포 시 공유 Docker 볼륨에서 `plc_address_map.json` 파일을 읽어 Modbus 읽기 로직을 동적으로 구성합니다.
    *   **Modbus 데이터 수집**: `node-red-contrib-modbus` (또는 유사한 노드)를 사용하여 `plc_address_map.json` 파일에 정의된 데이터 포인트(예: `pollingRate`, `address`, `functionCode`)에 따라 Modbus PLC와 Modbus TCP 연결을 설정하고 데이터를 폴링합니다.
    *   **데이터 처리**: 원시 Modbus 응답에 변환(예: `scaling`, `offset`, `dataType` 변환)을 적용하여 모니터링에 적합한 데이터로 준비합니다.
    *   **실시간 데이터 발행**: Node-RED의 **자동 생성 플로우**는 처리된 실시간 데이터를 **MQTT 브로커로 발행합니다.** **별도의 Node-RED 플로우**는 이 MQTT 데이터를 구독하여 WebSocket 서버(Node-RED의 `websocket-out` 노드 사용)를 통해 Svelte 프론트엔드로 발행합니다.

### 2.3. 공유 설정 파일 (`plc_address_map.json`)

*   **목적**: 이름, 주소, 기능 코드, 데이터 유형, 스케일링 요소, 단위, 폴링 주기 및 설명을 포함한 모든 Modbus 데이터 포인트를 정의합니다.
*   **위치**: Node.js Express 백엔드와 Node-RED 모두에서 접근 가능한 공유 Docker 볼륨에 위치합니다.

## 3. 통신 흐름

*   **설정 흐름**:
    1.  Svelte 프론트엔드는 HTTP API 호출을 통해 Node.js Express 백엔드로부터 `plc_address_map.json` 내용을 요청합니다.
    2.  Express 백엔드는 공유 볼륨에서 `plc_address_map.json` 파일을 읽어 Svelte 프론트엔드로 전송합니다.
    3.  Node-RED 또한 시작 시 공유 볼륨에서 `plc_address_map.json` 파일을 직접 읽어 Modbus 폴링 로직을 구성합니다.
*   **실시간 데이터 흐름**:
    1.  Node-RED의 **자동 생성 플로우**는 `plc_address_map.json` 설정에 따라 PLC를 지속적으로 폴링하고 원시 Modbus 데이터를 처리합니다.
    2.  처리된 데이터는 **MQTT 브로커의 특정 토픽으로 발행됩니다.**
    3.  **별도의 Node-RED 플로우**는 MQTT 브로커의 해당 토픽을 구독하여 데이터를 수신합니다.
    4.  이 플로우는 수신된 데이터를 WebSocket 서버에 발행합니다.
    5.  Svelte 프론트엔드는 Node-RED에 WebSocket 연결을 설정하고, 표시를 위해 이 실시간 데이터 업데이트를 수신합니다.

## 4. 배포 전략

*   **Docker 컨테이너**: 특화된 웹 애플리케이션(Svelte/Express)과 Node-RED는 별도의 Docker 컨테이너로 배포됩니다.
*   **Docker Compose**: `docker-compose.yml` 파일은 이 두 서비스 **및 MQTT 브로커**를 정의하고 오케스트레이션하는 데 사용되며, `plc_address_map.json`을 위한 공유 볼륨 설정 및 컨테이너 간 네트워크 통신 구성을 포함합니다.

## 5. 이 아키텍처의 장점

*   **명확한 역할 분리**: Node-RED는 산업 통신에 집중하고, 웹 애플리케이션은 사용자 상호 작용 및 설정을 처리합니다.
*   **경량 UI**: Svelte는 빠르고 효율적인 프론트엔드를 가능하게 합니다.
*   **확장성**: 구성 요소를 독립적으로 확장할 수 있습니다.
*   **유지보수성**: 모듈식 설계는 개발 및 문제 해결을 단순화합니다.
*   **유연성**: `plc_address_map.json`을 통해 Node-RED 플로우를 직접 변경하지 않고도 데이터 포인트를 쉽게 수정할 수 있습니다.
*   **느슨한 결합 및 확장성**: MQTT 브로커를 통한 데이터 발행/구독 모델은 Node-RED 플로우 간의 결합도를 낮추고, 향후 데이터베이스 저장 등 새로운 데이터 소비자를 쉽게 추가할 수 있도록 확장성을 제공합니다.